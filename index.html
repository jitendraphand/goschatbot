<button id="rec">Speak</button>
<audio id="player" controls></audio>

<script>
let recorder, chunks = [], stream;

document.getElementById("rec").onclick = async function () {
  if (!recorder || recorder.state === "inactive") {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: "audio/wav" });
      const form = new FormData();
      form.append("audio", blob);

      const res = await fetch("https://gurukulolympiad.app.n8n.cloud/webhook/voice-query", {
        method: "POST",
        body: form
      });

      const audioBlob = await res.blob();
      document.getElementById("player").src =
        URL.createObjectURL(audioBlob);
    };

    recorder.start();
    this.textContent = "Stop";
  } else {
    recorder.stop();
    stream.getTracks().forEach(t => t.stop());
    this.textContent = "Speak";
  }
};
</script>
