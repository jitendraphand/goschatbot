<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Voice Query</title>

<style>
  body {
    margin: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #020617, #0f172a);
    font-family: system-ui, -apple-system, Segoe UI, sans-serif;
    color: #e5e7eb;
  }

  .card {
    width: 340px;
    padding: 26px;
    border-radius: 18px;
    background: #020617;
    box-shadow: 0 25px 40px rgba(0,0,0,.6);
    text-align: center;
  }

  h1 {
    font-size: 1.15rem;
    margin-bottom: 18px;
  }

  button {
    width: 100%;
    padding: 14px;
    font-size: 1rem;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    background: #2563eb;
    color: white;
    transition: background .2s;
  }

  button.recording {
    background: #dc2626;
  }

  button:disabled {
    opacity: .6;
    cursor: not-allowed;
  }

  .status {
    margin-top: 12px;
    font-size: .85rem;
    color: #9ca3af;
  }

  audio {
    width: 100%;
    margin-top: 18px;
    display: none;
  }

  audio.active {
    display: block;
  }
</style>
</head>

<body>
<div class="card">
  <h1>üéôÔ∏è Voice Query</h1>

  <button id="rec">Start Recording</button>
  <div class="status" id="status">Tap to speak</div>

  <audio id="player" controls></audio>
</div>

<script>
let recorder;
let chunks = [];
let stream;

const btn = document.getElementById("rec");
const status = document.getElementById("status");
const player = document.getElementById("player");

btn.addEventListener("click", async () => {
  try {
    if (!recorder || recorder.state === "inactive") {

      // Request microphone access (HTTPS required)
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Cross-browser MIME support
      const mimeType =
        MediaRecorder.isTypeSupported("audio/webm")
          ? "audio/webm"
          : "audio/mp4";

      recorder = new MediaRecorder(stream, { mimeType });
      chunks = [];

      recorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      recorder.onstop = async () => {
        status.textContent = "Processing...";
        btn.disabled = true;

        const blob = new Blob(chunks, { type: mimeType });
        const form = new FormData();

        // IMPORTANT: filename MUST have a valid extension
        const extension = mimeType === "audio/webm" ? "webm" : "m4a";
        form.append("audio", blob, `voice.${extension}`);

        const response = await fetch(
          "https://gurukulolympiad.app.n8n.cloud/webhook/voice-query",
          {
            method: "POST",
            body: form
          }
        );

        if (!response.ok) {
          status.textContent = "Server error";
          btn.disabled = false;
          return;
        }

        // Expecting audio response from n8n
        const audioBlob = await response.blob();
        player.src = URL.createObjectURL(audioBlob);
        player.classList.add("active");

        status.textContent = "Response ready";
        btn.disabled = false;
      };

      recorder.start();
      btn.textContent = "Stop Recording";
      btn.classList.add("recording");
      status.textContent = "Recording...";

    } else {
      recorder.stop();
      stream.getTracks().forEach(t => t.stop());
      btn.textContent = "Start Recording";
      btn.classList.remove("recording");
    }
  } catch (err) {
    console.error(err);
    status.textContent = "Microphone permission denied";
  }
});
</script>
</body>
</html>
