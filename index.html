<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gurukul Voice Assistant</title>

<style>
  body {
    margin: 0;
    height: 100vh;
    background: #f4f6fb;
    font-family: "Segoe UI", system-ui, sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .card {
    width: 360px;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 15px 35px rgba(0,0,0,.15);
    padding: 24px;
    text-align: center;
    border-top: 6px solid #1f3faa;
  }

  .logo {
    width: 160px;
    margin-bottom: 14px;
  }

  h1 {
    font-size: 1.05rem;
    color: #1f3faa;
    margin-bottom: 16px;
    font-weight: 600;
  }

  button {
    width: 100%;
    padding: 14px;
    font-size: 1rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: #1f3faa;
    color: white;
    transition: background .2s ease;
  }

  button:hover {
    background: #16318a;
  }

  button.recording {
    background: #c62828;
  }

  button:disabled {
    opacity: .6;
    cursor: not-allowed;
  }

  .status {
    margin-top: 10px;
    font-size: .85rem;
    color: #555;
  }

  audio {
    width: 100%;
    margin-top: 16px;
    display: none;
  }

  audio.active {
    display: block;
  }

  .footer {
    margin-top: 14px;
    font-size: .75rem;
    color: #888;
  }
</style>
</head>

<body>

<div class="card">
  <!-- LOGO -->
  <img src="logo.png" alt="Gurukul Olympiad School" class="logo" />

  <h1>Voice Query Assistant</h1>

  <button id="rec">Start Recording</button>
  <div class="status" id="status">Tap to speak</div>

  <audio id="player" controls></audio>

  <div class="footer">
    Gurukul Olympiad School
  </div>
</div>

<script>
let recorder;
let chunks = [];
let stream;

const btn = document.getElementById("rec");
const status = document.getElementById("status");
const player = document.getElementById("player");

btn.addEventListener("click", async () => {
  try {
    if (!recorder || recorder.state === "inactive") {

      stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      const mimeType =
        MediaRecorder.isTypeSupported("audio/webm")
          ? "audio/webm"
          : "audio/mp4";

      recorder = new MediaRecorder(stream, { mimeType });
      chunks = [];

      recorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      recorder.onstop = async () => {
        status.textContent = "Processing...";
        btn.disabled = true;

        const blob = new Blob(chunks, { type: mimeType });
        const form = new FormData();

        const extension = mimeType === "audio/webm" ? "webm" : "m4a";
        form.append("audio", blob, `voice.${extension}`);

        const response = await fetch(
          "https://gurukulolympiad.app.n8n.cloud/webhook/voice-query",
          {
            method: "POST",
            body: form
          }
        );

        if (!response.ok) {
          status.textContent = "Server error";
          btn.disabled = false;
          return;
        }

        const audioBlob = await response.blob();
        player.src = URL.createObjectURL(audioBlob);
        player.classList.add("active");

        status.textContent = "Response ready";
        btn.disabled = false;
      };

      recorder.start();
      btn.textContent = "Stop Recording";
      btn.classList.add("recording");
      status.textContent = "Recording...";

    } else {
      recorder.stop();
      stream.getTracks().forEach(t => t.stop());
      btn.textContent = "Start Recording";
      btn.classList.remove("recording");
    }
  } catch (err) {
    console.error(err);
    status.textContent = "Microphone permission denied";
  }
});
</script>

</body>
</html>
